<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">    
</head>

<body>


    <div class="container mx-auto px-4 py-5">
        <div class="w-full max-w-2xl mx-auto">
            <form class="bg-white shadow-md rounded px-4 pt-4 pb-4 mb-4">

              <!-- Offerings Section -->
               <div id="offeringsContainer">
                  <!-- Offerings will be loaded here -->
              </div>              
                <!-- Credit Card Information Section -->
                <div class="bg-gray-100 p-4 rounded-md shadow-sm mb-5">
                    <fieldset>
                        <legend class="text-lg font-bold mb-3">Credit Card Information</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Card Number -->
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="number">Card Number</label>
                                <input class="form-input" type="text" id="number" value="5520000000000000">
                            </div>
                            <!-- Expiry Month -->
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="expiry_month">Expiry Month</label>
                                <input class="form-input" type="text" id="expiry_month" value="05">
                            </div>
                            <!-- Expiry Year -->
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="expiry_year">Expiry Year</label>
                                <input class="form-input" type="text" id="expiry_year" value="2024">
                            </div>
                            <!-- CVC -->
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="cvc">CVC</label>
                                <input class="form-input" type="text" id="cvc" value="123">
                            </div>
                            <!-- Name on Card -->
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="name">Name on Card</label>
                                <input class="form-input" type="text" id="name" value="Roland Robot">
                            </div>
                        </div>
                    </fieldset>
                </div>

                <!-- Funds Recipient Section -->
                <div class="bg-gray-100 p-4 rounded-md shadow-sm mb-5">
                    <fieldset>
                        <legend class="text-lg font-bold mb-3">Funds Recipient</legend>
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Account Number, BSB Number, Account Name -->
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="accountNumber">Account Number</label>
                                <input class="form-input" type="text" id="accountNumber" value="987654321">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="bsbNumber">BSB Number</label>
                                <input class="form-input" type="text" id="bsbNumber" value="123456">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-1" for="accountName">Account Name</label>
                                <input class="form-input" type="text" id="accountName" value="Mr Roland Robot">
                            </div>
                        </div>
                    </fieldset>
                </div>

                <!-- Amount to Transfer Section -->
                <div class="bg-gray-100 p-4 rounded-md shadow-sm mb-5">
                    <fieldset>
                        <legend class="text-lg font-bold mb-3">Amount to Transfer</legend>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1" for="transferAmount">Amount</label>
                            <input class="form-input" type="number" id="transferAmount" placeholder="Enter amount">
                        </div>
                    </fieldset>
                </div>



                <!-- RFQ Button -->
                <div class="flex items-center justify-between mt-4">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                        Request Quote
                    </button>
                </div>

                <!-- Quote Section -->
                <div id="quoteContainer">
                    <!-- Quote will be loaded here -->
                </div>              
    

            </form>
        </div>
    </div>
</body>


<script type="module">
    import {TbdexHttpClient, DevTools, Rfq, Quote, Order, Close, OrderStatus} from 'https://cdn.jsdelivr.net/npm/@tbdex/http-client@0.22.1/dist/browser.mjs'
    console.log(TbdexHttpClient)

    async function createOrLoadDid() {
      try {
        // Check if the DID exists in local storage
        const data = localStorage.getItem("did");
        if (data) {
          return JSON.parse(data);
        } else {
          // If the DID doesn't exist, generate a new DID
          const did = await DevTools.createDid();
          localStorage.setItem("did", JSON.stringify(did));
          return did;
        }
      } catch (error) {
        console.error('Error with Local Storage:', error);
      }
    } 
    
    // create or load the customer did
    const did = await createOrLoadDid();
    console.log("customer id", did.did);

    // load the PFI (liquidity node) did from http://localhost:9000/did
    const pfiDid = await fetch('http://localhost:9000/did').then(r => r.text());
    console.log(pfiDid);


    // load the offerings from the PFI
    const { data:offerings } = await TbdexHttpClient.getOfferings({ pfiDid: pfiDid });
    console.log("offerings", offerings);
    
    
    // show the offerings on the page
    async function showOfferings(data) {
      const offeringsContainer = document.getElementById('offeringsContainer');      
      data.forEach(offering => {
        const offeringElement = document.createElement('div');
        offeringElement.className = 'bg-gray-100 p-4 rounded-md shadow-sm mb-5';
        
        const flagImage = document.createElement('img');
        flagImage.src = `https://flagcdn.com/w160/au.png`; // Update with correct path
        flagImage.alt = 'Flag';
        flagImage.style = 'width: 50px; height: 30px;';
        offeringElement.appendChild(flagImage);

        const description = document.createElement('p');
        description.textContent = offering.data.description;
        offeringElement.appendChild(description);

        const payoutCurrency = document.createElement('p');
        payoutCurrency.textContent = `Payout Currency: ${offering.data.payoutCurrency.currencyCode}`;
        offeringElement.appendChild(payoutCurrency);

        const payinMethods = document.createElement('p');
        payinMethods.textContent = `Pay-in Methods: ${offering.data.payinMethods.map(m => m.kind).join(', ')}`;
        offeringElement.appendChild(payinMethods);

        offeringsContainer.appendChild(offeringElement);
      });
    }


    showOfferings(offerings);

    // Function to get Verifiable Credential
    async function getVerifiableCredential(name) {
        return await fetch(`http://localhost:9000/vc?name=${name}&country=Australia&did=${did.id}`).then(r => r.text());        
    }

  


    // Process the Request for Quote
    async function handleRFQRequest(event) {
        event.preventDefault(); // Prevent default form submission behavior

        const name = document.getElementById('name').value; // Get the name from the form
        const credential = await getVerifiableCredential(name); // Get the Verifiable Credential

        const transferAmount = document.getElementById('transferAmount').value; // Get the transfer amount from the form


        const rfq = Rfq.create({
            metadata: { from: did.did, to: pfiDid },
            data: {
                offeringId: offerings[0].id,
                payinSubunits: transferAmount,
                payinMethod: {
                    kind: 'CREDIT_CARD',
                    paymentDetails: {
                        cc_number: document.getElementById('number').value,
                        expiry_month: document.getElementById('expiry_month').value,
                        expiry_year: document.getElementById('expiry_year').value,
                        cvc: document.getElementById('cvc').value,
                        name: document.getElementById('name').value
                    }
                },
                payoutMethod: {
                    kind: 'AUSTRALIAN_BANK_ACCOUNT',
                    paymentDetails: {
                        accountNumber: '987654321', // replace with actual account number
                        bsbNumber: '123456', // replace with actual BSB number
                        accountName: 'Mr Roland Robot' // replace with actual account name
                    }
                },
                claims: [credential]
            }})
        
        await rfq.sign(did)
        const resp = await TbdexHttpClient.sendMessage({ message: rfq })
        // asser that the response is a success
        console.log('send rfq response', JSON.stringify(resp, null, 2))

        // All interaction with the PFI happens in the context of an exchange.
        const exchanges = await TbdexHttpClient.getExchanges({pfiDid: pfiDid,filter: { id: rfq.exchangeId },did })          
        const [exchange] = exchanges.data;

        // find the quote 
        const quote = exchange.find(message => message instanceof Quote);
        
        // show the quote on the page
        const quoteContainer = document.getElementById('quoteContainer');
        const quoteElement = document.createElement('div');
        quoteElement.className = 'bg-gray-100 p-4 rounded-md shadow-sm mb-5';
        const quoteText = document.createElement('p');
        quoteText.textContent = `Pay recipient \$${quote.data.payout.amountSubunits} ${quote.data.payout.currencyCode}`;
        quoteElement.appendChild(quoteText);
        quoteContainer.appendChild(quoteElement);

        // add a button to accept the quote
        const acceptButton = document.createElement('button');
        acceptButton.className = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline';
        acceptButton.textContent = 'Accept Quote';
        acceptButton.addEventListener('click', async (event) => {  
            event.preventDefault()    
            
            const order = Order.create({
                metadata: { from: did.did, to: pfiDid, exchangeId: quote.exchangeId },
            })

            await order.sign(did)
            const orderResponse = await TbdexHttpClient.sendMessage({ message: order })
            console.log('we have an order response')
            console.log('orderResponse',  JSON.stringify(orderResponse, null, 2))  
            
            // now poll for the order status
            while(true) {
                const exchanges = await TbdexHttpClient.getExchanges({pfiDid: pfiDid,filter: { id: rfq.exchangeId },did })   
                const [exchange] = exchanges.data;
                // find the quote 
                const close = exchange.find(message => message instanceof Close);
                if (close) {
                    console.log('we have a close')
                    console.log('close', JSON.stringify(close, null, 2))

                    // appent the close to the page
                    const closeElement = document.createElement('div');
                    closeElement.className = 'bg-gray-100 p-4 rounded-md shadow-sm mb-5';
                    const closeText = document.createElement('p');
                    closeText.textContent = `Order Result: ${close.data.reason}`;
                    closeElement.appendChild(closeText);
                    quoteContainer.appendChild(closeElement);
                    break
                }

                // rest for a bit
                await new Promise(resolve => setTimeout(resolve, 1000))

            }

        })
        quoteElement.appendChild(acceptButton);


    }

    const rfqButton = document.querySelector('form button[type="submit"]');
    rfqButton.addEventListener('click', handleRFQRequest);
    
    


    

  </script>

  
</html>
